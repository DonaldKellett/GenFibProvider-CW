BeforeAll {
  Import-Module SHiPS
  Move-Item GenFibProvider.ps1 -Destination GenFibProvider.psm1 -Force
  Import-Module ./GenFibProvider.psm1
}

Describe 'GenFibProvider' {
  BeforeEach {
    New-PSDrive -Name GF -Root GenFibProvider#GenFib -PSProvider SHiPS -WarningAction 'SilentlyContinue'
  }
  It 'Default values should be correct' {
    Get-Content GF:\Order | Should -Be '2'
    Get-Content GF:\Start | Should -Be '0'
    Get-Content GF:\Count | Should -Be '10'
    Get-Content GF:\Sequence | Should -Be '0,1,1,2,3,5,8,13,21,34'
  }
  It 'should allow Set-Content on Order, Start and Count' {
    Set-Content GF:\Order -Value 3
    Set-Content GF:\Start -Value 15
    Set-Content GF:\Count -Value 20
    Get-Content GF:\Order | Should -Be '3'
    Get-Content GF:\Start | Should -Be '15'
    Get-Content GF:\Count | Should -Be '20'
    Get-Content GF:\Sequence | Should -Be '1705,3136,5768,10609,19513,35890,66012,121415,223317,410744,755476,1389537,2555757,4700770,8646064,15902591,29249425,53798080,98950096,181997601'
  }
  It 'should prevent setting values less than 0 on Order, Start and Count' {
    Set-Content GF:\Order -Value -1 -ErrorAction 'SilentlyContinue'
    Set-Content GF:\Start -Value -2 -ErrorAction 'SilentlyContinue'
    Set-Content GF:\Count -Value -3 -ErrorAction 'SilentlyContinue'
    Get-Content GF:\Order | Should -Be '2'
    Get-Content GF:\Start | Should -Be '0'
    Get-Content GF:\Count | Should -Be '10'
    Get-Content GF:\Sequence | Should -Be '0,1,1,2,3,5,8,13,21,34'
  }
  It 'should generate an empty sequence correctly' {
    Set-Content GF:\Count -Value 0
    Get-Content GF:\Order | Should -Be '2'
    Get-Content GF:\Start | Should -Be '0'
    Get-Content GF:\Count | Should -Be '0'
    Get-Content GF:\Sequence | Should -Be ''
  }
  It 'should generate 0th and 1st order Fibonacci sequences correctly' {
    Set-Content GF:\Order -Value 0
    Get-Content GF:\Order | Should -Be '0'
    Get-Content GF:\Start | Should -Be '0'
    Get-Content GF:\Count | Should -Be '10'
    Get-Content GF:\Sequence | Should -Be '0,0,0,0,0,0,0,0,0,0'
    Set-Content GF:\Order -Value 1
    Get-Content GF:\Order | Should -Be '1'
    Get-Content GF:\Start | Should -Be '0'
    Get-Content GF:\Count | Should -Be '10'
    Get-Content GF:\Sequence | Should -Be '1,1,1,1,1,1,1,1,1,1'
  }
  It 'should handle huge terms with arbitrary precision' {
    Set-Content GF:\Order -Value 4
    Set-Content GF:\Start -Value 1000
    Set-Content GF:\Count -Value 10
    Get-Content GF:\Order | Should -Be '4'
    Get-Content GF:\Start | Should -Be '1000'
    Get-Content GF:\Count | Should -Be '10'
    Get-Content GF:\Sequence | Should -Be '80612965543569013375053017657224193322814498804143605698949253030259897351461707903235835255206857522960377247566119902833745107612558849667330639399422732632784532453583865206618002987209702170391793700471749898929136523409356835657014641447629317324840860079447184465668382508012160,155386487112698876882601209682029556632177900932040654518248792050815287733497578518001001590550339537843118599243360180094325020412540796229523519671963959933127789940462658031102391772377739557008973736110891207803031489891423491099112473746284316902564807862289706322535617913392464,299517084062305961271197450060548710193833914774804869385020450471674353347770821611556008473399004135437817486369130162329157490360167590197241792365573002856499027758154485336071405429388900504321726219181254434211653834703163964084106532034135255953816382572802916154130354011249952,577337742246023880714610808747758940875853058358348741598107849896435926088621153807718671865988038028080806972476482727431526331997169238462119255833504794304037971570985304879033739311074383486333975730733496338167528475996628534149112362649902477345101287999082953989896498809588385,1112854278964597732243462486147561401024679372869337871200326345449185464521351261840511517185144239224322120305655092972688753950382436474556215207270464489726449321723186313452825539500050725718056469386497391879111350324000572824989346009877951367526323338513622760932230853242242961,2145095592385626451111871954637898608726544246934532136701703437868111031691240815777787199115081620925683863363744066042543762793152314099445099775141506246820114110992788761699033076012891749265721145072523033859293564124591788814321677378308273417727805816947798337398793323976473762,4134804697658554025341142699593767660820910592937023618885158083685406775648984053037573396639612902313524608128244771904993200565892087402660676030611048533707100432045114865366963760253405758974433316408935176510784096759292154137544242282870262518553046826033306968475051030039555060,7970092311254802089411087949126986611447987271099242368385295716899139197950197284463590784805826800491611398770120413647657243641424007215124110268856524064557701836332075245397856115077422617444544906598689098587356539683881144311004378033706389781152277269493811020795971706067860168,15362846880263580298107565089506214282020121483840135995172483583901842469811773415119462897745665562955141990567764344567882960950850845191786101281879543334811365701093165185916678490843770851402755837466644700836545550891765660087859643704762877084959453250988539087602046913326131951,29612839481562562863971667692864867163015563594810934119144640822354499475102195568398414278306186886685961860829873596163077167951319253909015987356488622179896282080463144058380531442187490977087455205546792009793979751459530747350729941399647802802392583163463455414271862973410020941'
  }
  AfterEach {
    Remove-PSDrive -Name GF
  }
}

AfterAll {
  Remove-Module GenFibProvider
  Move-Item GenFibProvider.psm1 -Destination GenFibProvider.ps1 -Force
  Remove-Module SHiPS
}
